<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Client Records System</title>
    <style>
        /* Part 2: CSS Styles */
        body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}
.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    overflow: hidden;
}
.header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 30px 40px;
    text-align: center;
    position: relative;
}
.header h1 {
    margin: 0 0 10px 0;
    font-size: 2.5em;
}
.logout-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.logout-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
}
.login-container {
    max-width: 400px;
    margin: 50px auto;
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    overflow: hidden;
}
.login-header {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    padding: 30px;
    text-align: center;
}
.login-form {
    padding: 40px;
}
.security-badge {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(76, 175, 80, 0.9);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
}
.content {
    padding: 40px;
}
.section {
    background: #f8f9fa;
    margin-bottom: 30px;
    padding: 30px;
    border-radius: 10px;
    border-left: 5px solid #667eea;
}
.section h2 {
    color: #2c3e50;
    margin-top: 0;
    font-size: 1.8em;
}
.upload-area {
    border: 3px dashed #667eea;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    background: white;
    margin: 20px 0;
    transition: all 0.3s ease;
}
.upload-area:hover {
    border-color: #5a67d8;
    background: #f7faff;
}
.upload-area.dragover {
    border-color: #4c51bf;
    background: #edf2f7;
}
.btn {
    padding: 12px 30px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin: 10px;
    text-decoration: none;
    display: inline-block;
}
.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}
.btn-success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
}
.btn-info {
    background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
    color: white;
}
.btn-danger {
    background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
    color: white;
}
.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
.form-group {
    margin-bottom: 20px;
}
.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2d3748;
}
.form-group input, .form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s ease;
    box-sizing: border-box;
}
.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #667eea;
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 30px 0;
}
.stat-card {
    background: white;
    padding: 25px;
    border-radius: 10px;
    text-align: center;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 10px;
}
.stat-label {
    color: #718096;
    font-size: 1.1em;
}
.progress-bar {
    width: 100%;
    height: 20px;
    background: #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    margin: 10px 0;
}
.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #48bb78, #38a169);
    width: 0%;
    transition: width 0.3s ease;
}
.alert {
    padding: 15px 20px;
    border-radius: 8px;
    margin: 15px 0;
    font-weight: 500;
}
.alert-success {
    background: #f0fff4;
    color: #22543d;
    border: 1px solid #9ae6b4;
}
.alert-error {
    background: #fff5f5;
    color: #742a2a;
    border: 1px solid #feb2b2;
}
.alert-info {
    background: #ebf8ff;
    color: #2a4365;
    border: 1px solid #90cdf4;
}
.table-container {
    overflow-x: auto;
    margin: 20px 0;
}
table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
th, td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}
th {
    background: #667eea;
    color: white;
    font-weight: 600;
}
tr:hover {
    background: #f7faff;
}
.badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}
.badge-success {
    background: #d4edda;
    color: #155724;
}
.badge-danger {
    background: #f8d7da;
    color: #721c24;
}
.badge-secondary {
    background: #e2e3e5;
    color: #383d41;
}
.btn-sm {
    padding: 6px 12px;
    font-size: 14px;
}
form {
    background: white;
    padding: 25px;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}
.hidden {
    display: none;
}
.login-attempts {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 10px 15px;
    border-radius: 5px;
    margin: 10px 0;
    font-size: 14px;
}
.loading-spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 10px;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.upload-progress-enhanced {
    background: #f8f9fa;
    border: 2px solid #667eea;
    border-radius: 10px;
    padding: 20px;
    margin: 20px 0;
}
.upload-speed {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}
.upload-eta {
    font-size: 14px;
    color: #333;
    font-weight: bold;
    margin-top: 5px;
}
.chunk-progress {
    background: #e9ecef;
    border-radius: 4px;
    height: 6px;
    margin: 10px 0;
    overflow: hidden;
}
.chunk-fill {
    background: linear-gradient(90deg, #007bff, #0056b3);
    height: 100%;
    width: 0%;
    transition: width 0.3s ease;
}
.upload-status-detailed {
    font-size: 16px;
    font-weight: 600;
    margin: 10px 0;
}
.upload-cancel-btn {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
}
.file-size-warning {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}
.retry-upload {
    background: #fd7e14;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 10px;
}
        
    </style>
</head>
<body>
    /* Part 1: HTML Structure (without <html>, <head>, <body> tags) */
        <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Client Records System</title>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-header">
            <h1>üîê Admin Login</h1>
            <p>Client Records System Administration</p>
        </div>
        <div class="login-form">
            <form id="loginForm">
                <div class="form-group">
                    <label for="adminUsername">Username:</label>
                    <input type="text" id="adminUsername" name="username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <input type="password" id="adminPassword" name="password" required autocomplete="current-password">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="rememberMe" style="margin-right: 8px;">
                        Remember me for 7 days
                    </label>
                </div>
                
                <div id="loginError" class="alert alert-error hidden">
                    Invalid credentials. Please try again.
                </div>
                
                <div id="loginAttempts" class="login-attempts hidden">
                    Too many failed attempts. Please wait before trying again.
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="loginBtn">
                    üöÄ Login to Dashboard
                </button>
            </form>
            
            <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; text-align: center; font-size: 14px; color: #2e7d32; border: 1px solid #4caf50;">
                <strong>üîí Secure System</strong><br>
                <em>Contact administrator for login credentials</em>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="container hidden">
        <div class="header">
            <div class="security-badge">
                üîí Secured Session
            </div>
            <button class="logout-btn" onclick="logout()">
                üö™ Logout
            </button>
            <h1>üèõÔ∏è Admin Dashboard</h1>
            <p>Client Records Data Entry System</p>
        </div>

        <div class="content">
            <!-- Statistics Section -->
            <div class="section">
                <h2>üìä System Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAgents">0</div>
                        <div class="stat-label">Total Agents</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalTasks">0</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedTasks">0</div>
                        <div class="stat-label">Completed Tasks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingTasks">0</div>
                        <div class="stat-label">Pending Tasks</div>
                    </div>
                </div>
            </div>

            <!-- Upload ZIP Section -->
            <div class="section">
                <h2>üìÅ Upload Task Images</h2>
                <p>Upload a ZIP file containing images to assign tasks to agents.</p>
                
                <div class="form-group">
                    <label for="agentSelect">Assign to Agent:</label>
                    <select id="agentSelect" required>
                        <option value="">Select an agent...</option>
                    </select>
                </div>

                <div id="fileSizeWarning" class="file-size-warning hidden">
                    <strong>‚ö†Ô∏è Large File Detected:</strong> 
                    <span id="fileSizeWarningText"></span>
                    <br>Upload will use chunked transfer for better reliability.
                </div>

                <div class="upload-area" id="uploadArea">
                    <div>
                        <h3>üìé Drop ZIP file here or click to upload</h3>
                        <p>Supported formats: .zip (containing .jpg, .jpeg, .png images)</p>
                        <input type="file" id="zipFile" accept=".zip" style="display: none;">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('zipFile').click()">
                            Choose ZIP File
                        </button>
                    </div>
                </div>

                <div id="uploadProgress" class="upload-progress-enhanced hidden">
                    <h4>üöÄ Upload Progress</h4>
                    <div class="upload-status-detailed" id="uploadStatusDetailed">Preparing upload...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 14px; margin-top: 5px;">
                        <span id="uploadedBytes">0 MB</span>
                        <span id="totalBytes">0 MB</span>
                    </div>
                    
                    <div id="chunkProgressContainer" class="hidden">
                        <div style="font-size: 14px; color: #666; margin: 10px 0;">Chunk Progress:</div>
                        <div class="chunk-progress">
                            <div class="chunk-fill" id="chunkFill"></div>
                        </div>
                        <div style="font-size: 12px; color: #666;" id="chunkInfo">Chunk 0 of 0</div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div class="upload-speed" id="uploadSpeed">Speed: Calculating...</div>
                        <div class="upload-eta" id="uploadETA">ETA: Calculating...</div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button id="cancelUploadBtn" class="upload-cancel-btn" onclick="cancelUpload()">
                            ‚ùå Cancel Upload
                        </button>
                        <button id="retryUploadBtn" class="retry-upload hidden" onclick="retryUpload()">
                            üîÑ Retry Upload
                        </button>
                    </div>
                </div>

                <button type="button" class="btn btn-success" id="uploadBtn" onclick="uploadZipFile()" disabled>
                    üöÄ Upload & Assign Tasks
                </button>
            </div>

            <!-- Export Data Section -->
            <div class="section">
                <h2>üìä Export Submitted Data</h2>
                <p>Download all submitted form data as Excel spreadsheet.</p>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="exportAgent">Filter by Agent (Optional):</label>
                        <select id="exportAgent">
                            <option value="">All Agents</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="dateFrom">From Date (Optional):</label>
                        <input type="date" id="dateFrom">
                    </div>
                    
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="dateTo">To Date (Optional):</label>
                        <input type="date" id="dateTo">
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-info" onclick="exportToExcel()">
                        üì• Download Excel Report
                    </button>
                    <button type="button" class="btn btn-success" onclick="previewData()">
                        üëÅÔ∏è Preview Data
                    </button>
                    <button type="button" class="btn btn-primary" onclick="testDataAvailability()">
                        üîç Test Data Availability
                    </button>
                </div>
            </div>

            <!-- Agent Registration Section -->
            <div class="section">
                <h2>üë§ Register New Agent</h2>
                <p>Create a new agent account with auto-generated credentials.</p>
                
                <form id="agentRegistrationForm">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-group">
                            <label for="agentName">Full Name:</label>
                            <input type="text" id="agentName" name="name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="agentEmail">Email:</label>
                            <input type="email" id="agentEmail" name="email" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="agentMobile">Mobile Number:</label>
                            <input type="tel" id="agentMobile" name="mobile" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="agentDob">Date of Birth:</label>
                            <input type="date" id="agentDob" name="dob" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="agentCountry">Country:</label>
                            <input type="text" id="agentCountry" name="country" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="agentGender">Gender:</label>
                            <select id="agentGender" name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button type="submit" class="btn btn-primary">
                            üîë Register Agent & Generate Credentials
                        </button>
                    </div>
                </form>
                
                <div id="newAgentCredentials" class="hidden" style="margin-top: 30px; padding: 20px; background: #e8f5e8; border-radius: 10px; border: 2px solid #4caf50;">
                    <h3 style="color: #2e7d32; margin-top: 0;">‚úÖ Agent Registered Successfully!</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <strong>Agent ID:</strong><br>
                            <span id="newAgentId" style="font-size: 1.2em; color: #1976d2; font-family: monospace;"></span>
                            <button onclick="copyToClipboard('newAgentId')" class="btn btn-info" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">Copy</button>
                        </div>
                        <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                            <strong>Password:</strong><br>
                            <span id="newAgentPassword" style="font-size: 1.2em; color: #d32f2f; font-family: monospace;" class="hidden-password">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
                            <button onclick="togglePasswordVisibility('newAgentPassword')" class="btn btn-info" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">Show</button>
                            <button onclick="copyToClipboard('newAgentPassword')" class="btn btn-info" style="margin-left: 10px; padding: 5px 10px; font-size: 12px;">Copy</button>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>‚ö†Ô∏è Important:</strong> Please save these credentials securely.
                    </div>
                </div>
            </div>

            <!-- Agents Management Section -->
            <div class="section">
                <h2>üë• Agent Management</h2>
                
                <div class="table-container">
                    <table id="agentsTable">
                        <thead>
                            <tr>
                                <th>Agent ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Password</th>
                                <th>Status</th>
                                <th>Login Status</th>
                                <th>Tasks Completed</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agentsTableBody">
                            <!-- Agent data will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <button type="button" class="btn btn-primary" onclick="refreshAgents()">
                    üîÑ Refresh Agents
                </button>
            </div>

            <!-- Data Preview Section -->
            <div class="section hidden" id="dataPreviewSection">
                <h2>üìã Data Preview</h2>
                <div class="table-container">
                    <table id="dataPreviewTable">
                        <thead id="previewTableHead">
                            <!-- Headers will be dynamically generated -->
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
    <script>
        /* Part 3: JavaScript Logic */
        // Configuration
const BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8000' : ''; // Adjust for production
const SESSION_KEY = 'admin_session';
const REMEMBER_KEY = 'admin_remember';

// Enhanced upload configuration for large files
const CHUNK_SIZE = 5 * 1024 * 1024; // 5MB chunks
const MAX_RETRIES = 3;
const LARGE_FILE_THRESHOLD = 100 * 1024 * 1024; // 100MB

// Security and session management
let sessionTimeout;
let failedAttempts = 0;
let lockoutTime = null;
let agents = [];
let selectedZipFile = null;

// Enhanced upload state management
let uploadController = null;
let uploadStartTime = null;
let lastProgressUpdate = null;
let uploadRetryCount = 0;
let isChunkedUpload = false;
let currentChunk = 0;
let totalChunks = 0;

// Initialize application
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Initializing Admin Dashboard...');
    checkExistingSession();
    setupLoginForm();
    setupDragAndDrop();
    setupAgentRegistration();
    setupSessionMonitoring();
});

// Check for existing valid session
function checkExistingSession() {
    const session = getSession();
    const rememberToken = localStorage.getItem(REMEMBER_KEY);
    
    if (session && session.expiry > Date.now()) {
        console.log('‚úÖ Valid session found, showing dashboard');
        showDashboard();
        return;
    }
    
    if (rememberToken) {
        try {
            const remembered = JSON.parse(rememberToken);
            if (remembered.expiry > Date.now()) {
                console.log('‚úÖ Remember token valid, auto-login');
                createSession(true);
                showDashboard();
                return;
            } else {
                localStorage.removeItem(REMEMBER_KEY);
            }
        } catch (e) {
            localStorage.removeItem(REMEMBER_KEY);
        }
    }
    
    console.log('üîê No valid session, showing login');
    showLogin();
}

// Setup login form
function setupLoginForm() {
    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await handleLogin();
    });
}

// Handle login attempt
async function handleLogin() {
    if (lockoutTime && Date.now() < lockoutTime) {
        const remainingTime = Math.ceil((lockoutTime - Date.now()) / 1000);
        showLoginError(`Too many failed attempts. Please wait ${remainingTime} seconds.`);
        return;
    }

    const username = document.getElementById('adminUsername').value;
    const password = document.getElementById('adminPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    const loginBtn = document.getElementById('loginBtn');

    loginBtn.innerHTML = '<div class="loading-spinner"></div>Logging in...';
    loginBtn.disabled = true;

    try {
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        if (await validateCredentials(username, password)) {
            createSession(rememberMe);
            failedAttempts = 0;
            lockoutTime = null;
            showDashboard();
            showAlert('Login successful! Welcome to the admin dashboard.', 'success');
        } else {
            failedAttempts++;
            
            if (failedAttempts >= 3) {
                lockoutTime = Date.now() + (30 * 1000);
                showLoginError('Too many failed attempts. Account locked for 30 seconds.');
            } else {
                showLoginError(`Invalid credentials. ${3 - failedAttempts} attempts remaining.`);
            }
        }
    } catch (error) {
        showLoginError('Login error. Please try again.');
    } finally {
        loginBtn.innerHTML = 'üöÄ Login to Dashboard';
        loginBtn.disabled = false;
    }
}

// SECURE CREDENTIAL VALIDATION - IMPLEMENT SERVER-SIDE AUTHENTICATION
async function validateCredentials(username, password) {
    // Placeholder for server-side authentication
    try {
        const response = await fetch(`${BASE_URL}/api/admin/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        return response.ok;
    } catch (error) {
        console.error('Authentication error:', error);
        return false;
    }
}

// Create session
function createSession(rememberMe = false) {
    const session = {
        authenticated: true,
        loginTime: Date.now(),
        expiry: Date.now() + (2 * 60 * 60 * 1000), // 2 hours
        username: document.getElementById('adminUsername').value
    };
    
    sessionStorage.setItem(SESSION_KEY, JSON.stringify(session));
    
    if (rememberMe) {
        const rememberToken = {
            expiry: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days
        };
        localStorage.setItem(REMEMBER_KEY, JSON.stringify(rememberToken));
    }
    
    setupSessionTimeout();
}

// Get current session
function getSession() {
    try {
        const session = sessionStorage.getItem(SESSION_KEY);
        return session ? JSON.parse(session) : null;
    } catch (e) {
        return null;
    }
}

// Setup session timeout and monitoring
function setupSessionTimeout() {
    if (sessionTimeout) {
        clearTimeout(sessionTimeout);
    }
    
    sessionTimeout = setTimeout(() => {
        showAlert('Session expired. Please login again.', 'info');
        logout();
    }, 2 * 60 * 60 * 1000);
}

// Setup session activity monitoring
function setupSessionMonitoring() {
    const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
    let lastActivity = Date.now();
    
    activityEvents.forEach(event => {
        document.addEventListener(event, () => {
            const now = Date.now();
            if (now - lastActivity > 60000) {
                lastActivity = now;
                extendSession();
            }
        });
    });
    
    setInterval(() => {
        const session = getSession();
        if (!session || session.expiry <= Date.now()) {
            if (!document.getElementById('dashboard').classList.contains('hidden')) {
                showAlert('Session expired. Please login again.', 'info');
                logout();
            }
        }
    }, 60000);
}

// Extend session
function extendSession() {
    const session = getSession();
    if (session && session.expiry > Date.now()) {
        session.expiry = Date.now() + (2 * 60 * 60 * 1000);
        sessionStorage.setItem(SESSION_KEY, JSON.stringify(session));
        setupSessionTimeout();
    }
}

// Show login screen
function showLogin() {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('dashboard').classList.add('hidden');
    document.getElementById('adminUsername').focus();
}

// Show dashboard
function showDashboard() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    loadDashboardData();
}

// Show login error
function showLoginError(message) {
    const errorDiv = document.getElementById('loginError');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
    
    setTimeout(() => {
        errorDiv.classList.add('hidden');
    }, 5000);
}

// Logout function
function logout() {
    if (uploadController) {
        uploadController.abort();
    }
    
    sessionStorage.removeItem(SESSION_KEY);
    localStorage.removeItem(REMEMBER_KEY);
    
    if (sessionTimeout) {
        clearTimeout(sessionTimeout);
    }
    
    document.getElementById('loginForm').reset();
    document.getElementById('loginError').classList.add('hidden');
    
    showLogin();
    showAlert('Logged out successfully.', 'info');
}

// Enhanced API request function with auth
async function makeAuthenticatedRequest(url, options = {}) {
    const session = getSession();
    
    if (!session || session.expiry <= Date.now()) {
        showAlert('Session expired. Please login again.', 'error');
        logout();
        throw new Error('Session expired');
    }
    
    const authOptions = {
        ...options,
        headers: {
            ...options.headers,
            'Authorization': `Bearer ${session.username}`,
            'X-Session-Token': session.loginTime
        }
    };
    
    try {
        const response = await fetch(url, authOptions);
        
        if (response.status === 401 || response.status === 403) {
            showAlert('Authentication failed. Please login again.', 'error');
            logout();
            throw new Error('Authentication failed');
        }
        
        return response;
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            showAlert('Network error. Please check your connection.', 'error');
        }
        throw error;
    }
}

// Setup agent registration form
function setupAgentRegistration() {
    document.getElementById('agentRegistrationForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await registerNewAgent();
    });
}

// Register new agent with validation
async function registerNewAgent() {
    const email = document.getElementById('agentEmail').value;
    const mobile = document.getElementById('agentMobile').value;
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const mobileRegex = /^\+?\d{10,15}$/;
    
    if (!emailRegex.test(email)) {
        showAlert('Please enter a valid email address', 'error');
        return;
    }
    if (!mobileRegex.test(mobile)) {
        showAlert('Please enter a valid mobile number (10-15 digits)', 'error');
        return;
    }

    const formData = new FormData(document.getElementById('agentRegistrationForm'));
    
    const submitBtn = document.querySelector('#agentRegistrationForm button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Registering...';
    submitBtn.disabled = true;

    try {
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/agents/register`, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            if (!result.agent_id || !result.password) {
                throw new Error('Invalid server response: Missing agent_id or password');
            }
            const passwordElement = document.getElementById('newAgentPassword');
            passwordElement.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            passwordElement.dataset.password = result.password;
            document.getElementById('newAgentId').textContent = result.agent_id;
            document.getElementById('newAgentCredentials').classList.remove('hidden');
            
            document.getElementById('agentRegistrationForm').reset();
            
            await loadAgents();
            populateAgentSelects();
            
            showAlert(`Agent registered successfully! ID: ${result.agent_id}`, 'success');
            document.getElementById('newAgentCredentials').scrollIntoView({ behavior: 'smooth' });
        } else {
            const error = result.detail || 'Unknown error occurred';
            if (response.status === 400) {
                showAlert(`Invalid input: ${error}`, 'error');
            } else if (response.status === 409) {
                showAlert(`Agent already exists: ${error}`, 'error');
            } else {
                showAlert(`Registration failed: ${error}`, 'error');
            }
        }
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            console.error('Registration error:', {
                message: error.message,
                stack: error.stack,
                responseStatus: response?.status,
                responseText: await response?.text().catch(() => 'N/A')
            });
            showAlert('Network error during registration', 'error');
        }
    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
}

// Load all dashboard data
async function loadDashboardData() {
    console.log('üìä Loading dashboard data...');
    await Promise.all([
        loadStatistics(),
        loadAgents(),
        populateAgentSelects()
    ]);
}

// Load system statistics
async function loadStatistics() {
    try {
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/statistics`);
        const stats = await response.json();
        
        document.getElementById('totalAgents').textContent = stats.total_agents || 0;
        document.getElementById('totalTasks').textContent = stats.total_tasks || 0;
        document.getElementById('completedTasks').textContent = stats.completed_tasks || 0;
        document.getElementById('pendingTasks').textContent = stats.pending_tasks || 0;
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            console.error('Failed to load statistics:', error);
            showAlert('Failed to load statistics', 'error');
        }
    }
}

// Load agents list
async function loadAgents() {
    try {
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/agents`);
        agents = await response.json();
        
        updateAgentsTable();
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            console.error('Failed to load agents:', error);
            showAlert('Failed to load agents', 'error');
        }
    }
}

// Copy to clipboard function
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.classList.contains('hidden-password') ? element.dataset.password : element.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        const button = element.nextElementSibling.tagName === 'BUTTON' ? element.nextElementSibling : element.nextElementSibling.nextElementSibling;
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.style.background = '#4caf50';
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = '';
        }, 2000);
    }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        showAlert('Credentials copied to clipboard!', 'success');
    });
}

// Toggle password visibility
function togglePasswordVisibility(elementId) {
    const element = document.getElementById(elementId);
    const button = element.nextElementSibling;
    if (element.classList.contains('hidden-password')) {
        element.textContent = element.dataset.password || element.textContent;
        element.classList.remove('hidden-password');
        button.textContent = 'Hide';
    } else {
        element.dataset.password = element.textContent;
        element.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        element.classList.add('hidden-password');
        button.textContent = 'Show';
    }
}

// Update agents table
function updateAgentsTable() {
    const tbody = document.getElementById('agentsTableBody');
    tbody.innerHTML = '';
    
    agents.forEach(agent => {
        const row = document.createElement('tr');
        
        row.innerHTML = `
            <td>${agent.agent_id}</td>
            <td>${agent.name}</td>
            <td>${agent.email}</td>
            <td>
                <span style="font-family: monospace; background: #f0f0f0; padding: 4px; border-radius: 4px;">
                    ${agent.password || '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}
                </span>
                <button class="btn btn-sm" style="padding: 2px 6px; margin-left: 5px;" 
                        onclick="showPassword('${agent.agent_id}')" title="Show Password">
                    üëÅÔ∏è
                </button>
                <button class="btn btn-sm" style="padding: 2px 6px; margin-left: 2px;" 
                        onclick="resetPassword('${agent.agent_id}')" title="Reset Password">
                    üîÑ
                </button>
            </td>
            <td><span class="badge ${agent.status === 'active' ? 'badge-success' : 'badge-danger'}">${agent.status}</span></td>
            <td>
                <span class="badge ${agent.is_currently_logged_in ? 'badge-success' : 'badge-secondary'}">
                    ${agent.is_currently_logged_in ? 'üü¢ Online' : 'üî¥ Offline'}
                </span>
            </td>
            <td>${agent.tasks_completed || 0}</td>
            <td>
                <button class="btn btn-sm ${agent.status === 'active' ? 'btn-danger' : 'btn-success'}" 
                        onclick="toggleAgentStatus('${agent.agent_id}', '${agent.status}')">
                    ${agent.status === 'active' ? 'Deactivate' : 'Activate'}
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Show agent password
async function showPassword(agentId) {
    try {
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/agent-password/${agentId}`);
        const result = await response.json();
        
        if (response.ok) {
            showAlert(result.message, 'info');
        } else {
            showAlert(`Error: ${result.detail}`, 'error');
        }
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            showAlert('Error retrieving password information', 'error');
        }
    }
}

// Reset agent password
async function resetPassword(agentId) {
    if (!confirm('Are you sure you want to reset this agent\'s password?')) {
        return;
    }
    
    try {
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/reset-password/${agentId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (response.ok) {
            alert(`New Password for ${agentId}: ${result.new_password}\n\nPlease save this password securely.`);
            showAlert(`Password reset successfully for agent ${agentId}`, 'success');
            await loadAgents();
        } else {
            showAlert(`Password reset failed: ${result.detail}`, 'error');
        }
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            showAlert('Error resetting password', 'error');
        }
    }
}

// Populate agent select dropdowns
function populateAgentSelects() {
    const agentSelect = document.getElementById('agentSelect');
    const exportAgentSelect = document.getElementById('exportAgent');
    
    agentSelect.innerHTML = '<option value="">Select an agent...</option>';
    exportAgentSelect.innerHTML = '<option value="">All Agents</option>';
    
    agents.forEach(agent => {
        if (agent.status === 'active') {
            const option1 = new Option(`${agent.name} (${agent.agent_id})`, agent.agent_id);
            const option2 = new Option(`${agent.name} (${agent.agent_id})`, agent.agent_id);
            agentSelect.appendChild(option1);
            exportAgentSelect.appendChild(option2);
        }
    });
}

// Setup drag and drop functionality
function setupDragAndDrop() {
    const uploadArea = document.getElementById('uploadArea');
    const zipFileInput = document.getElementById('zipFile');

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].name.endsWith('.zip')) {
            handleZipFileSelection(files[0]);
        } else {
            showAlert('Please drop a valid ZIP file', 'error');
        }
    });

    zipFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleZipFileSelection(e.target.files[0]);
        }
    });
}

// ZIP file selection handler
function handleZipFileSelection(file) {
    selectedZipFile = file;
    
    const fileSizeMB = file.size / (1024 * 1024);
    
    document.querySelector('#uploadArea h3').textContent = `üìé Selected: ${file.name}`;
    document.querySelector('#uploadArea p').innerHTML = `Size: ${fileSizeMB.toFixed(2)} MB`;
    
    if (fileSizeMB > 100) {
        const warningDiv = document.getElementById('fileSizeWarning');
        const warningText = document.getElementById('fileSizeWarningText');
        warningText.textContent = `File size is ${fileSizeMB.toFixed(2)} MB. This is considered a large file.`;
        warningDiv.classList.remove('hidden');
    } else {
        document.getElementById('fileSizeWarning').classList.add('hidden');
    }
    
    updateUploadButtonState();
    showAlert(`ZIP file "${file.name}" selected successfully!`, 'success');
}

// Update upload button state
function updateUploadButtonState() {
    const uploadBtn = document.getElementById('uploadBtn');
    const agentSelected = document.getElementById('agentSelect').value !== '';
    uploadBtn.disabled = !(selectedZipFile && agentSelected);
}

// Agent selection change handler
document.getElementById('agentSelect').addEventListener('change', updateUploadButtonState);

// Enhanced upload function with chunking support
async function uploadZipFile() {
    if (!selectedZipFile || !document.getElementById('agentSelect').value) {
        showAlert('Please select both a ZIP file and an agent', 'error');
        return;
    }

    const fileSize = selectedZipFile.size;
    isChunkedUpload = fileSize > LARGE_FILE_THRESHOLD;
    
    if (isChunkedUpload) {
        await uploadLargeFile();
    } else {
        await uploadStandardFile();
    }
}

// Standard file upload
async function uploadStandardFile() {
    const formData = new FormData();
    formData.append('zip_file', selectedZipFile);
    formData.append('agent_id', document.getElementById('agentSelect').value);

    showUploadProgress();
    uploadStartTime = Date.now();

    try {
        uploadController = new AbortController();
        
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/upload-tasks`, {
            method: 'POST',
            body: formData,
            signal: uploadController.signal
        });

        const result = await response.json();

        if (response.ok) {
            hideUploadProgress();
            showAlert(`Successfully uploaded ${result.images_processed} images and assigned tasks!`, 'success');
            resetUploadForm();
            await loadStatistics();
        } else {
            throw new Error(result.detail || 'Upload failed');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Upload cancelled by user', 'info');
        } else if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            showAlert(`Upload failed: ${error.message}`, 'error');
            showRetryOption();
        }
    } finally {
        uploadController = null;
    }
}

// Large file upload with chunking
async function uploadLargeFile() {
    totalChunks = Math.ceil(selectedZipFile.size / CHUNK_SIZE);
    currentChunk = 0;
    
    showUploadProgress(true);
    uploadStartTime = Date.now();

    try {
        uploadController = new AbortController();
        
        const initData = new FormData();
        initData.append('filename', selectedZipFile.name);
        initData.append('filesize', selectedZipFile.size);
        initData.append('total_chunks', totalChunks);
        initData.append('agent_id', document.getElementById('agentSelect').value);

        const initResponse = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/init-chunked-upload`, {
            method: 'POST',
            body: initData,
            signal: uploadController.signal
        });

        if (!initResponse.ok) {
            throw new Error('Failed to initialize chunked upload');
        }

        const { upload_id } = await initResponse.json();

        for (let i = 0; i < totalChunks; i++) {
            if (uploadController.signal.aborted) {
                throw new Error('Upload cancelled');
            }

            await uploadChunk(upload_id, i);
            currentChunk = i + 1;
            updateChunkProgress();
        }

        const finalizeData = new FormData();
        finalizeData.append('upload_id', upload_id);

        const finalizeResponse = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/finalize-chunked-upload`, {
            method: 'POST',
            body: finalizeData,
            signal: uploadController.signal
        });

        if (!finalizeResponse.ok) {
            throw new Error('Failed to finalize upload');
        }

        const result = await finalizeResponse.json();
        
        hideUploadProgress();
        showAlert(`Successfully uploaded ${result.images_processed} images and assigned tasks!`, 'success');
        resetUploadForm();
        await loadStatistics();
    } catch (error) {
        if (error.name === 'AbortError' || error.message === 'Upload cancelled') {
            showAlert('Upload cancelled by user', 'info');
        } else if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            showAlert(`Upload failed: ${error.message}`, 'error');
            showRetryOption();
        }
    } finally {
        uploadController = null;
    }
}

// Upload individual chunk
async function uploadChunk(uploadId, chunkIndex) {
    const start = chunkIndex * CHUNK_SIZE;
    const end = Math.min(start + CHUNK_SIZE, selectedZipFile.size);
    const chunk = selectedZipFile.slice(start, end);

    let retries = 0;
    while (retries < MAX_RETRIES) {
        try {
            const formData = new FormData();
            formData.append('upload_id', uploadId);
            formData.append('chunk_index', chunkIndex);
            formData.append('chunk', chunk);

            const response = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/upload-chunk`, {
                method: 'POST',
                body: formData,
                signal: uploadController.signal
            });

            if (response.ok) {
                updateOverallProgress((chunkIndex + 1) / totalChunks * 100);
                break;
            } else {
                throw new Error(`Chunk ${chunkIndex} upload failed`);
            }
        } catch (error) {
            retries++;
            if (retries >= MAX_RETRIES) {
                throw new Error(`Failed to upload chunk ${chunkIndex} after ${MAX_RETRIES} retries`);
            }
            
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, retries) * 1000));
        }
    }
}

// Show upload progress
function showUploadProgress(isChunked = false) {
    document.getElementById('uploadProgress').classList.remove('hidden');
    document.getElementById('uploadBtn').disabled = true;
    document.getElementById('cancelUploadBtn').classList.remove('hidden');
    document.getElementById('retryUploadBtn').classList.add('hidden');
    
    if (isChunked) {
        document.getElementById('chunkProgressContainer').classList.remove('hidden');
        totalChunks = Math.ceil(selectedZipFile.size / CHUNK_SIZE);
        document.getElementById('chunkInfo').textContent = `Chunk 0 of ${totalChunks}`;
    } else {
        document.getElementById('chunkProgressContainer').classList.add('hidden');
    }
    
    updateOverallProgress(0);
    updateUploadSpeed(0);
}

// Hide upload progress
function hideUploadProgress() {
    document.getElementById('uploadProgress').classList.add('hidden');
    document.getElementById('uploadBtn').disabled = false;
    updateUploadButtonState();
}

// Update overall progress
function updateOverallProgress(percentage) {
    const progressFill = document.getElementById('progressFill');
    const uploadedBytes = document.getElementById('uploadedBytes');
    const totalBytes = document.getElementById('totalBytes');
    const statusDetailed = document.getElementById('uploadStatusDetailed');
    
    progressFill.style.width = `${Math.min(percentage, 100)}%`;
    
    const uploaded = (selectedZipFile.size * percentage / 100);
    uploadedBytes.textContent = `${(uploaded / (1024 * 1024)).toFixed(1)} MB`;
    totalBytes.textContent = `${(selectedZipFile.size / (1024 * 1024)).toFixed(1)} MB`;
    
    if (percentage < 100) {
        statusDetailed.textContent = `Uploading... ${percentage.toFixed(1)}%`;
    } else {
        statusDetailed.textContent = 'Processing uploaded file...';
    }
    
    updateUploadSpeed(uploaded);
    lastProgressUpdate = Date.now();
}

// Update chunk progress
function updateChunkProgress() {
    if (!isChunkedUpload) return;
    
    const chunkFill = document.getElementById('chunkFill');
    const chunkInfo = document.getElementById('chunkInfo');
    
    const chunkPercentage = (currentChunk / totalChunks) * 100;
    chunkFill.style.width = `${chunkPercentage}%`;
    chunkInfo.textContent = `Chunk ${currentChunk} of ${totalChunks}`;
}

// Update upload speed and ETA
function updateUploadSpeed(uploadedBytes) {
    if (!uploadStartTime) return;
    
    const elapsed = (Date.now() - uploadStartTime) / 1000;
    const speed = uploadedBytes / elapsed;
    const speedMBps = speed / (1024 * 1024);
    
    const remaining = selectedZipFile.size - uploadedBytes;
    const eta = remaining / speed;
    
    document.getElementById('uploadSpeed').textContent = 
        `Speed: ${speedMBps.toFixed(2)} MB/s`;
    
    if (eta > 0 && eta < Infinity) {
        const etaMinutes = Math.floor(eta / 60);
        const etaSeconds = Math.floor(eta % 60);
        document.getElementById('uploadETA').textContent = 
            `ETA: ${etaMinutes}m ${etaSeconds}s`;
    } else {
        document.getElementById('uploadETA').textContent = 'ETA: Calculating...';
    }
}

// Cancel upload
function cancelUpload() {
    if (uploadController) {
        uploadController.abort();
        hideUploadProgress();
        showAlert('Upload cancelled', 'info');
    }
}

// Show retry option
function showRetryOption() {
    document.getElementById('retryUploadBtn').classList.remove('hidden');
    document.getElementById('cancelUploadBtn').classList.add('hidden');
}

// Retry upload
function retryUpload() {
    if (uploadRetryCount < MAX_RETRIES) {
        uploadRetryCount++;
        showAlert(`Retrying upload (attempt ${uploadRetryCount + 1})...`, 'info');
        uploadZipFile();
    } else {
        showAlert('Maximum retry attempts reached. Please try again later.', 'error');
        hideUploadProgress();
    }
}

// Reset upload form
function resetUploadForm() {
    selectedZipFile = null;
    uploadRetryCount = 0;
    document.getElementById('agentSelect').value = '';
    document.getElementById('zipFile').value = '';
    document.querySelector('#uploadArea h3').textContent = 'üìé Drop ZIP file here or click to upload';
    document.querySelector('#uploadArea p').innerHTML = 'Supported formats: .zip (containing .jpg, .jpeg, .png images)';
    document.getElementById('fileSizeWarning').classList.add('hidden');
    updateUploadButtonState();
}

// Export data to Excel
async function exportToExcel() {
    const filters = {
        agent_id: document.getElementById('exportAgent').value,
        date_from: document.getElementById('dateFrom').value,
        date_to: document.getElementById('dateTo').value
    };

    const queryParams = new URLSearchParams();
    Object.entries(filters).forEach(([key, value]) => {
        if (value) queryParams.append(key, value);
    });

    try {
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/export-excel?${queryParams}`, {
            method: 'GET'
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `crime_records_export_${new Date().toISOString().split('T')[0]}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('Excel file downloaded successfully!', 'success');
        } else {
            const error = await response.json();
            showAlert(`Export failed: ${error.detail}`, 'error');
        }
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            console.error('Export error:', error);
            showAlert('Network error during export', 'error');
        }
    }
}

// Preview data
async function previewData() {
    const filters = {
        agent_id: document.getElementById('exportAgent').value,
        date_from: document.getElementById('dateFrom').value,
        date_to: document.getElementById('dateTo').value
    };

    const queryParams = new URLSearchParams();
    Object.entries(filters).forEach(([key, value]) => {
        if (value) queryParams.append(key, value);
    });

    try {
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/preview-data?${queryParams}`);
        const data = await response.json();

        if (response.ok) {
            displayDataPreview(data);
            document.getElementById('dataPreviewSection').classList.remove('hidden');
        } else {
            showAlert(`Preview failed: ${data.detail}`, 'error');
        }
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            console.error('Preview error:', error);
            showAlert('Network error during preview', 'error');
        }
    }
}

// Test data availability
async function testDataAvailability() {
    try {
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/admin/test-data`);
        const data = await response.json();

        if (response.ok) {
            showAlert(`Data test successful: ${data.message}`, 'success');
        } else {
            showAlert(`Data test failed: ${data.detail}`, 'error');
        }
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            console.error('Data test error:', error);
            showAlert('Network error during data test', 'error');
        }
    }
}

// Display data preview
function displayDataPreview(data) {
    const thead = document.getElementById('previewTableHead');
    const tbody = document.getElementById('previewTableBody');

    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="100%">No data found with current filters</td></tr>';
        return;
    }

    const headers = Object.keys(data[0]);
    const headerRow = document.createElement('tr');
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header.replace(/_/g, ' ').toUpperCase();
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);

    data.slice(0, 50).forEach(row => {
        const tr = document.createElement('tr');
        headers.forEach(header => {
            const td = document.createElement('td');
            td.textContent = row[header] || '';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });

    if (data.length > 50) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="${headers.length}" style="text-align: center; font-style: italic; color: #666;">Showing first 50 of ${data.length} records. Download Excel for complete data.</td>`;
        tbody.appendChild(tr);
    }
}

// Toggle agent status
async function toggleAgentStatus(agentId, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    
    try {
        const response = await makeAuthenticatedRequest(`${BASE_URL}/api/agents/${agentId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        });

        if (response.ok) {
            showAlert(`Agent status updated to ${newStatus}`, 'success');
            loadAgents();
        } else {
            const error = await response.json();
            showAlert(`Failed to update status: ${error.detail}`, 'error');
        }
    } catch (error) {
        if (error.message !== 'Authentication failed' && error.message !== 'Session expired') {
            console.error('Status update error:', error);
            showAlert('Network error during status update', 'error');
        }
    }
}

// Refresh agents
function refreshAgents() {
    loadDashboardData();
    showAlert('Data refreshed successfully!', 'success');
}

// Show alert messages
function showAlert(message, type) {
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());

    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;

    const content = document.querySelector('.content');
    if (content) {
        content.insertBefore(alert, content.firstChild);
    } else {
        const loginForm = document.querySelector('.login-form');
        if (loginForm) {
            loginForm.insertBefore(alert, loginForm.firstChild);
        }
    }

    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Security enhancements
document.addEventListener('contextmenu', function(e) {
    if (e.target.closest('.credential-value') || e.target.closest('input[type="password"]')) {
        e.preventDefault();
    }
});

document.addEventListener('dragstart', function(e) {
    if (e.target.closest('.credential-value') || e.target.closest('input[type="password"]')) {
        e.preventDefault();
    }
});

window.addEventListener('beforeunload', function() {
    const passwordInputs = document.querySelectorAll('input[type="password"]');
    passwordInputs.forEach(input => input.value = '');
    
    if (uploadController) {
        uploadController.abort();
    }
});

history.pushState(null, null, location.href);
window.addEventListener('popstate', function() {
    history.pushState(null, null, location.href);
});

document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        const session = getSession();
        if (session && session.expiry > Date.now()) {
            extendSession();
        }
    }
});

let suspiciousActivityCount = 0;
const MAX_SUSPICIOUS_ACTIVITIES = 5;

function detectSuspiciousActivity(activityType) {
    suspiciousActivityCount++;
    
    if (suspiciousActivityCount >= MAX_SUSPICIOUS_ACTIVITIES) {
        showAlert('Suspicious activity detected. Session will be terminated for security.', 'error');
        setTimeout(() => {
            logout();
        }, 3000);
    }
}

document.getElementById('adminPassword').addEventListener('input', function() {
    if (failedAttempts >= 2) {
        if (this.value.length > 3) {
            suspiciousActivityCount = 0;
        }
    }
});

document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.shiftKey && e.key === 'L') {
        e.preventDefault();
        if (getSession()) {
            logout();
            showAlert('Quick logout activated', 'info');
        }
    }
    
    if (e.key === 'Escape' && uploadController) {
        cancelUpload();
    }
});

function showSessionInfo() {
    const session = getSession();
    if (session) {
        const timeRemaining = Math.max(0, Math.floor((session.expiry - Date.now()) / 60000));
        console.log(`Session active. Time remaining: ${timeRemaining} minutes`);
    }
}

setInterval(showSessionInfo, 10 * 60 * 1000);

window.addEventListener('online', function() {
    showAlert('Internet connection restored', 'success');
});

window.addEventListener('offline', function() {
    showAlert('Internet connection lost. Upload will pause.', 'error');
});

function cleanupFileReferences() {
    if (selectedZipFile && !uploadController) {
        const fileName = selectedZipFile.name;
        selectedZipFile = null;
        console.log(`Cleaned up memory for file: ${fileName}`);
    }
}

setInterval(cleanupFileReferences, 5 * 60 * 1000);

console.log('‚úÖ Admin Dashboard initialized successfully');
console.log('üîó Using dynamic BASE_URL for API calls');
    </script>
</body>
</html>
